<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Compliance Toolkit Server</title>
    <style>
        :root {
            --primary: #1e40af;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #0284c7;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #f87171;
            --warning: #fbbf24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav a:hover {
            color: var(--primary);
        }

        .nav a.active {
            color: var(--primary);
            font-weight: 600;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .section {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
        }

        .setting-label h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-label p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .setting-value {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
        }

        .toggle {
            width: 50px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--success);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle.active::after {
            left: 26px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }


        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d1fae5;
            color: var(--success);
        }

        .badge.danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .badge.warning {
            background: #fef3c7;
            color: var(--warning);
        }

        .badge.info {
            background: #dbeafe;
            color: var(--info);
        }

        [data-theme="dark"] .badge.success {
            background: #064e3b;
            color: #6ee7b7;
        }

        [data-theme="dark"] .badge.danger {
            background: #7f1d1d;
            color: #fca5a5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert.success {
            background: #d1fae5;
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert.error {
            background: #fee2e2;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            background: var(--bg-secondary);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        .stat-badge {
            display: inline-block;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">‚öôÔ∏è Compliance Toolkit</div>
            <nav class="nav">
                <a href="/dashboard">Dashboard</a>
                <a href="/clients">Clients</a>
                <a href="/policies">Policies</a>
                <a href="/settings" class="active">Settings</a>
                <a href="/about">About</a>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåì</button>
                <button class="logout-btn" onclick="logout()" title="Logout">Logout</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <div id="alert" class="alert"></div>

        <!-- Server Information -->
        <div class="section">
            <div class="section-title">üì° Server Information</div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Server Version</h3>
                    <p>Current server version</p>
                </div>
                <div class="setting-value">
                    <span class="stat-badge" id="server-version">Loading...</span>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Server Address</h3>
                    <p>HTTPS endpoint for clients</p>
                </div>
                <div class="setting-value">
                    <code id="server-address">Loading...</code>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>TLS Status</h3>
                    <p>HTTPS encryption status</p>
                </div>
                <div class="setting-value">
                    <span class="badge" id="tls-status">Loading...</span>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Database Type</h3>
                    <p>Database backend</p>
                </div>
                <div class="setting-value">
                    <span class="badge info" id="db-type">Loading...</span>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Database Connection</h3>
                    <p>PostgreSQL connection details</p>
                </div>
                <div class="setting-value">
                    <code id="db-connection">Loading...</code>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Authentication</h3>
                    <p>API key authentication status</p>
                </div>
                <div class="setting-value">
                    <span class="badge" id="auth-status">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Login Message -->
        <div class="section">
            <div class="section-title">üí¨ Login Message</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Customize the message displayed on the login page.
            </p>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>Login Message</h3>
                    <p>Message shown to users on the login page</p>
                </div>
                <div class="setting-value">
                    <input type="text" id="login-message-input" placeholder="Enter login message" style="width: 100%; max-width: 400px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                </div>
            </div>

            <div style="margin-top: 16px;">
                <button class="btn-success" onclick="updateLoginMessage()">üíæ Save Login Message</button>
            </div>

            <div style="margin-top: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                <strong>üí° Tip:</strong> Use this to welcome users or display important notices (e.g., "Scheduled maintenance tonight at 10 PM").
            </div>
        </div>

        <!-- API Keys Management -->
        <div class="section">
            <div class="section-title">üîë API Keys</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Generate and manage API keys for client authentication. Keys are securely hashed and stored in the database.
            </p>

            <div style="margin-bottom: 16px;">
                <button class="btn-success" onclick="showGenerateKeyModal()">+ Generate New API Key</button>
            </div>

            <div id="api-keys-table">
                <p style="text-align: center; color: var(--text-secondary);">Loading API keys...</p>
            </div>

            <div style="margin-top: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                <strong>üí° Tip:</strong> API keys are shown ONCE when generated. Store them securely - they cannot be recovered later.
            </div>
        </div>

        <!-- User Management -->
        <div class="section">
            <div class="section-title">üë§ User Management</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Manage user accounts for web dashboard access.
            </p>

            <div style="margin-bottom: 16px;">
                <button class="btn-success" onclick="showAddUserModal()">+ Add New User</button>
            </div>

            <div id="users-table">
                <p style="text-align: center; color: var(--text-secondary);">Loading users...</p>
            </div>

            <div style="margin-top: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                <strong>üí° Roles:</strong><br>
                <strong>Admin:</strong> Full access including user management<br>
                <strong>Viewer:</strong> Read-only dashboard access<br>
                <strong>Auditor:</strong> View reports and export data
            </div>
        </div>

        <!-- Client Management -->
        <div class="section">
            <div class="section-title">üíª Registered Clients</div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                View and manage registered compliance clients.
            </p>

            <div id="clients-table">
                <p style="text-align: center; color: var(--text-secondary);">Loading clients...</p>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="section" style="border-color: var(--danger);">
            <div class="section-title" style="color: var(--danger);">‚ö†Ô∏è Danger Zone</div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Clear All Submissions</h3>
                    <p style="color: var(--danger);">Delete all compliance submissions (keeps clients)</p>
                </div>
                <div class="setting-value">
                    <button class="btn-danger" onclick="confirmClearSubmissions()">üóëÔ∏è Clear Submissions</button>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <h3>Reset Database</h3>
                    <p style="color: var(--danger);">Delete ALL data (clients and submissions)</p>
                </div>
                <div class="setting-value">
                    <button class="btn-danger" onclick="confirmResetDatabase()">‚ö†Ô∏è Reset Database</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate API Key Modal -->
    <div id="generate-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Generate New API Key</div>
            <div class="form-group">
                <label>Key Name</label>
                <input type="text" id="new-key-name" placeholder="Enter a descriptive name (e.g., 'Production Server')">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('generate-key-modal')">Cancel</button>
                <button class="btn-success" onclick="generateApiKey()">üîë Generate Key</button>
            </div>
        </div>
    </div>

    <!-- API Key Reveal Modal -->
    <div id="key-reveal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚ö†Ô∏è Save Your API Key</div>
            <div style="padding: 16px; background: var(--warning); color: #000; border-radius: 6px; margin-bottom: 16px;">
                <strong>Important:</strong> This is the ONLY time you will see this key. Copy it now and store it securely.
            </div>
            <div class="form-group">
                <label>API Key</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="revealed-key" readonly style="flex: 1; font-family: monospace; background: var(--bg-secondary);">
                    <button class="btn-secondary" onclick="copyRevealedKey()">üìã Copy</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-success" onclick="closeModal('key-reveal-modal'); loadAPIKeys();">I've Saved It</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Add New User</div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="new-username" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="new-password" placeholder="Enter password (min 8 characters)">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="new-role">
                    <option value="admin">Admin - Full access</option>
                    <option value="viewer" selected>Viewer - Read-only</option>
                    <option value="auditor">Auditor - View & export</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
                <button class="btn-success" onclick="addUser()">Create User</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Change Password</div>
            <input type="hidden" id="change-password-username">
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="change-new-password" placeholder="Enter new password (min 8 characters)">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('change-password-modal')">Cancel</button>
                <button class="btn-success" onclick="changePassword()">Change Password</button>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/v1/auth/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please try again.');
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert active ${type}`;
            setTimeout(() => {
                alert.className = 'alert';
            }, 5000);
        }

        // Modal functions
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Load server configuration
        async function loadServerInfo() {
            try {
                // Get server version and status from root endpoint
                const rootResponse = await fetch('/');
                const rootData = await rootResponse.json();
                document.getElementById('server-version').textContent = `v${rootData.version || '1.0.0'}`;

                // Get detailed config from settings API
                const configResponse = await fetch('/api/v1/settings/config', {
                    headers: {
                        'Authorization': 'Bearer demo-key-67890'
                    }
                });

                if (!configResponse.ok) throw new Error('Failed to load config');

                const config = await configResponse.json();

                // Update server info
                const protocol = config.server.tls.enabled ? 'https' : 'http';
                const address = `${protocol}://${config.server.host}:${config.server.port}`;
                document.getElementById('server-address').textContent = address;

                // TLS status
                const tlsStatus = document.getElementById('tls-status');
                if (config.server.tls.enabled) {
                    tlsStatus.textContent = 'Enabled';
                    tlsStatus.className = 'badge success';
                } else {
                    tlsStatus.textContent = 'Disabled';
                    tlsStatus.className = 'badge warning';
                }

                // Database info
                document.getElementById('db-type').textContent = config.database.type.toUpperCase();
                const dbConnection = `${config.database.host}:${config.database.port}/${config.database.name}`;
                document.getElementById('db-connection').textContent = dbConnection;

                // Auth status
                const authStatus = document.getElementById('auth-status');
                if (config.auth.enabled && config.auth.require_key) {
                    authStatus.textContent = `Enabled (${config.auth.key_count} keys)`;
                    authStatus.className = 'badge success';
                } else {
                    authStatus.textContent = 'Disabled';
                    authStatus.className = 'badge danger';
                }

            } catch (error) {
                console.error('Failed to load server info:', error);
                document.getElementById('server-version').textContent = 'Error';
            }
        }

        // Login message management
        async function loadLoginMessage() {
            try {
                const response = await fetch('/api/v1/config/login-message');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('login-message-input').value = data.message || '';
                }
            } catch (error) {
                console.error('Failed to load login message:', error);
            }
        }

        async function updateLoginMessage() {
            const message = document.getElementById('login-message-input').value;

            try {
                const response = await fetch('/api/v1/config/login-message/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update login message');
                }

                showAlert('Login message updated successfully! (Runtime only - update server.yaml for persistence)', 'success');
            } catch (error) {
                console.error('Failed to update login message:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // API Key management - Load from database
        async function loadAPIKeys() {
            try {
                console.log('Loading API keys...');
                const response = await fetch('/api/v1/apikeys', {
                    credentials: 'same-origin'
                });

                console.log('Response status:', response.status);
                if (!response.ok) throw new Error('Failed to load API keys');

                const keys = await response.json();
                console.log('Keys loaded:', keys);

                const html = keys.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Key Prefix</th>
                                <th>Created By</th>
                                <th>Created</th>
                                <th>Last Used</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${keys.map(key => `
                                <tr>
                                    <td>${key.name}</td>
                                    <td><code>${key.key_prefix}</code></td>
                                    <td>${key.created_by}</td>
                                    <td>${new Date(key.created_at).toLocaleDateString()}</td>
                                    <td>${key.last_used ? new Date(key.last_used).toLocaleDateString() : 'Never'}</td>
                                    <td>
                                        <span class="badge ${key.is_active ? 'success' : 'danger'}">
                                            ${key.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn-secondary" onclick="toggleAPIKey(${key.id}, ${!key.is_active})" style="padding: 4px 8px;">
                                            ${key.is_active ? '‚è∏Ô∏è Deactivate' : '‚ñ∂Ô∏è Activate'}
                                        </button>
                                        <button class="btn-danger" onclick="deleteAPIKey(${key.id})" style="padding: 4px 8px;">üóëÔ∏è Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align: center; color: var(--text-secondary);">No API keys generated yet</p>';

                document.getElementById('api-keys-table').innerHTML = html;

            } catch (error) {
                console.error('Failed to load API keys:', error);
                document.getElementById('api-keys-table').innerHTML =
                    '<p style="text-align: center; color: var(--danger);">Failed to load API keys</p>';
            }
        }

        function showGenerateKeyModal() {
            document.getElementById('new-key-name').value = '';
            document.getElementById('generate-key-modal').classList.add('active');
        }

        async function generateApiKey() {
            const name = document.getElementById('new-key-name').value.trim();

            if (!name) {
                showAlert('Please enter a name for the API key', 'error');
                return;
            }

            try {
                const response = await fetch('/api/v1/apikeys/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to generate API key');
                }

                const data = await response.json();

                // Close generate modal
                closeModal('generate-key-modal');

                // Show the key in reveal modal
                document.getElementById('revealed-key').value = data.api_key;
                document.getElementById('key-reveal-modal').classList.add('active');

                showAlert('API key generated successfully!', 'success');

            } catch (error) {
                console.error('Failed to generate API key:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        function copyRevealedKey() {
            const key = document.getElementById('revealed-key').value;
            navigator.clipboard.writeText(key).then(() => {
                showAlert('API key copied to clipboard!', 'success');
            });
        }

        async function deleteAPIKey(id) {
            if (!confirm('Delete this API key?\n\nClients using this key will no longer be able to connect.')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/apikeys/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ id })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to delete API key');
                }

                showAlert('API key deleted successfully!', 'success');
                await loadAPIKeys();

            } catch (error) {
                console.error('Failed to delete API key:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function toggleAPIKey(id, active) {
            try {
                const response = await fetch('/api/v1/apikeys/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ id, active })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to toggle API key');
                }

                showAlert(`API key ${active ? 'activated' : 'deactivated'} successfully!`, 'success');
                await loadAPIKeys();

            } catch (error) {
                console.error('Failed to toggle API key:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Client management
        async function loadClients() {
            try {
                const response = await fetch('/api/v1/clients', {
                    headers: {
                        'Authorization': 'Bearer demo-key-67890'
                    }
                });

                if (!response.ok) throw new Error('Failed to load clients');

                const clients = await response.json();

                const html = clients.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Hostname</th>
                                <th>Client ID</th>
                                <th>Status</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clients.map(client => `
                                <tr>
                                    <td><strong>${client.hostname || 'Unknown'}</strong></td>
                                    <td><code>${client.client_id}</code></td>
                                    <td><span class="badge ${client.status === 'active' ? 'success' : 'danger'}">${client.status || 'active'}</span></td>
                                    <td>${new Date(client.last_seen).toLocaleString()}</td>
                                    <td>
                                        <button class="btn-secondary" onclick="viewClient('${client.client_id}')">View</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align: center; color: var(--text-secondary);">No clients registered yet.</p>';

                document.getElementById('clients-table').innerHTML = html;

            } catch (error) {
                console.error('Failed to load clients:', error);
                document.getElementById('clients-table').innerHTML =
                    '<p style="text-align: center; color: var(--danger);">Failed to load clients</p>';
            }
        }

        function viewClient(clientId) {
            alert(`Client detail view coming soon!\n\nClient ID: ${clientId}`);
        }

        // Database functions
        async function confirmClearSubmissions() {
            if (confirm('Are you sure you want to delete ALL submissions?\n\nThis action cannot be undone.\n\nClients will remain registered.')) {
                try {
                    const response = await fetch('/api/v1/submissions/clear-all', {
                        method: 'POST',
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to clear submissions');
                    }

                    const result = await response.json();

                    // Show success popup
                    alert(`‚úÖ SUCCESS\n\n${result.message}\n\nClients remain registered and active.`);

                    // Also show styled alert
                    showAlert(`${result.message}`, 'success');

                    // Refresh the submission count
                    await loadClients();
                } catch (error) {
                    console.error('Failed to clear submissions:', error);

                    // Show error popup
                    alert(`‚ùå ERROR\n\nFailed to clear submissions:\n${error.message}`);

                    // Also show styled alert
                    showAlert('Error: ' + error.message, 'error');
                }
            }
        }

        function confirmResetDatabase() {
            const confirmation = prompt('Type "RESET DATABASE" to confirm complete database reset:');
            if (confirmation === 'RESET DATABASE') {
                showAlert('Reset PostgreSQL: DROP DATABASE compliance; CREATE DATABASE compliance; then restart server.', 'error');
            }
        }

        // User management
        function showAddUserModal() {
            document.getElementById('add-user-modal').classList.add('active');
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/v1/users', {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to load users');

                const users = await response.json();

                const html = users.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td><strong>${user.username}</strong></td>
                                    <td><span class="badge ${user.role === 'admin' ? 'danger' : user.role === 'auditor' ? 'warning' : 'secondary'}">${user.role}</span></td>
                                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                    <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                    <td>
                                        <button class="btn-secondary" onclick="showChangePasswordModal('${user.username}')">üîë Change Password</button>
                                        <button class="btn-danger" onclick="deleteUser('${user.username}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align: center; color: var(--text-secondary);">No users found.</p>';

                document.getElementById('users-table').innerHTML = html;
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('users-table').innerHTML =
                    '<p style="text-align: center; color: var(--danger);">Failed to load users</p>';
            }
        }

        async function addUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            if (!username || !password) {
                alert('Username and password are required');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            try {
                const response = await fetch('/api/v1/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ username, password, role })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create user');
                }

                showAlert('User created successfully!', 'success');
                closeModal('add-user-modal');
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                await loadUsers();
            } catch (error) {
                console.error('Failed to create user:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        function showChangePasswordModal(username) {
            document.getElementById('change-password-username').value = username;
            document.getElementById('change-password-modal').classList.add('active');
        }

        async function changePassword() {
            const username = document.getElementById('change-password-username').value;
            const newPassword = document.getElementById('change-new-password').value;

            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            try {
                const response = await fetch('/api/v1/users/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ username, new_password: newPassword })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to change password');
                }

                showAlert(`Password changed for user: ${username}`, 'success');
                closeModal('change-password-modal');
                document.getElementById('change-new-password').value = '';
            } catch (error) {
                console.error('Failed to change password:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/users/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ username })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }

                showAlert('User deleted successfully!', 'success');
                await loadUsers();
            } catch (error) {
                console.error('Failed to delete user:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }

        // Load data on page load
        loadServerInfo();
        loadLoginMessage();
        loadAPIKeys();
        loadClients();
        loadUsers();
    </script>
</body>
</html>
